desc: "Aos development setup for Renesas RCAR Gen4 hardware"
min_ver: "0.20"

variables:
  YOCTOS_WORK_DIR: "yocto"
  ZEPHYR_WORK_DIR: "zephyr"
  DOM0_BUILD_DIR: "build-dom0"
  DOMD_BUILD_DIR: "build-domd"
  XT_DOMD_DTB_NAME: "%{SOC_FAMILY}-%{MACHINE}-domd.dtb"
  XT_XEN_DTB_NAME: "%{SOC_FAMILY}-%{MACHINE}-xen.dtb"
  MACHINE: "spider"
  SOC_FAMILY: "r8a779f0"
  XT_DOMD_CONFIG_NAME: "domd-spider.cfg"
  XT_KERNEL_BRANCH: "v5.10.41/rcar-5.1.7.rc6-xt"
  XT_KERNEL_REV: "f5bb327b43cc6248cde9f3baf18e64257be8bc02"

common_data:
  # Sources used by all yocto-based domains
  sources: &COMMON_SOURCES
    - type: git
      url: "git://git.yoctoproject.org/poky"
      rev: "232b5533d"
    - type: git
      url: "git://git.openembedded.org/meta-openembedded"
      rev: "814eec96c"
    - type: git
      url: "git://git.yoctoproject.org/meta-virtualization"
      rev: "180241e"
    - type: git
      url: git://git.yoctoproject.org/meta-selinux
      rev: "46bcf05"
    - type: git
      url: https://github.com/renesas-rcar/meta-renesas.git
      rev: "7c29e7bdae360a86fa77ef561e01cc0c18d2e01f"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-common.git"
      rev: "dunfell"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-prod-devel-rcar-gen4.git"
      rev: "master"
    - type: git
      url: "https://github.com/aoscloud/meta-aos"
      rev: "develop"
    - type: git
      url: "https://github.com/aoscloud/meta-aos-rcar-gen4.git"
      rev: "develop"

  # Zephyr sources
  zephyr_sources: &ZEPHYR_SOURCES
    - type: west
      url: "https://github.com/aoscloud/aos_core_zephyr.git"
      rev: "develop"

  # Common configuration options for all yocto-based domains
  conf: &COMMON_CONF
    - [SSTATE_DIR, "${TOPDIR}/../../../common_data/sstate"]
    - [DL_DIR, "${TOPDIR}/../../../common_data/downloads"]

    # Skip warning about missing "virtualization" distro feature
    - [SKIP_META_VIRT_SANITY_CHECK, "1"]

    # Use hypervisor console on all guests
    - [SERIAL_CONSOLES, "115200;hvc0"]

    # Remove features that we are not using
    - [
        DISTRO_FEATURES_remove,
        "x11 gtk gobject-introspection-data wifi nfc
        bluetooth irda zeroconf 3g sysvinit acl alsa argp pcmcia usbgadget
        usbhost opengl ptest multiarch wayland vulkan sysvinit",
      ]

components:
  dom0:
    default: true
    build-dir: "%{ZEPHYR_WORK_DIR}/%{DOM0_BUILD_DIR}"
    sources:
      - *ZEPHYR_SOURCES

    builder:
      type: zephyr
      board: "rcar_spider"
      target: aos_core_zephyr
      work_dir: build

      shields:
        - "xen_dom0"

      target_images:
        - "build/zephyr/zephyr.bin"

  domd:
    default: true
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES

    builder:
      type: yocto
      work_dir: "%{DOMD_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - [XT_DOM_NAME, "domd"]
        - [XT_DEVICE_TREES, "%{XT_DOMD_DTB_NAME} %{XT_XEN_DTB_NAME}"]
        - [XT_KERNEL_BRANCH, "%{XT_KERNEL_BRANCH}"]
        - [XT_KERNEL_REV, "%{XT_KERNEL_REV}"]

        - [MACHINE, "%{MACHINE}"]
        - [SOC_FAMILY, "%{SOC_FAMILY}"]

        # Enable systemd on domd
        - [INIT_MANAGER, "systemd"]

        # add the static lib to SDK toolchain
        - [SDKIMAGE_FEATURES_append, " staticdev-pkgs"]

        # Add for gstreamer plugins ugly
        - [LICENSE_FLAGS_WHITELIST, "commercial"]

        # Add Capacity Aware migration Strategy (CAS)
        - [MACHINE_FEATURES_append, " cas"]

        # Remove ptest to reduce the build time
        - [DISTRO_FEATURES_remove, "ptest"]

        # Generate ext4 image files
        - [IMAGE_FSTYPES_append, " ext4"]

        - [EXTRA_IMAGEDEPENDS_append, " boot-script"]

        # Aos initramfs configuration
        - [INITRAMFS_IMAGE, "aos-image-initramfs"]
        - [INITRAMFS_IMAGE_BUNDLE, "0"]
        - [INITRAMFS_FSTYPES, "cpio.gz"]

      build_target: rcar-image-minimal
      layers:
        - "../poky/meta"
        - "../poky/meta-poky"
        - "../poky/meta-yocto-bsp"
        - "../meta-virtualization"
        - "../meta-selinux"
        - "../meta-openembedded/meta-oe"
        - "../meta-openembedded/meta-networking"
        - "../meta-openembedded/meta-python"
        - "../meta-openembedded/meta-filesystems"
        - "../meta-renesas/meta-rcar-gateway"
        - "../meta-xt-common/meta-xt-domx"
        - "../meta-xt-common/meta-xt-driver-domain"
        - "../meta-xt-prod-devel-rcar-gen4/meta-xt-domd-gen4"
        - "../meta-xt-prod-devel-rcar-gen4/meta-xt-domx-gen4"
        - "../meta-xt-prod-devel-rcar-gen4/meta-xt-driver-domain-gen4"
        - "../meta-aos"
        - "../meta-aos-rcar-gen4/meta-aos-rcar-gen4-domd"

      target_images:
        - "tmp/deploy/images/%{MACHINE}/Image"
        - "tmp/deploy/images/%{MACHINE}/rcar-image-minimal-%{MACHINE}.ext4"
        - "tmp/deploy/images/%{MACHINE}/bl31-%{MACHINE}.srec"
        - "tmp/deploy/images/%{MACHINE}/tee-%{MACHINE}.srec"
        - "tmp/deploy/images/%{MACHINE}/u-boot-elf-%{MACHINE}.srec"
        - "tmp/deploy/images/%{MACHINE}/xen-%{MACHINE}.uImage"
        - "tmp/deploy/images/%{MACHINE}/xenpolicy-%{MACHINE}"
        - "tmp/deploy/images/%{MACHINE}/r8a779f0-%{MACHINE}-xen.dtb"
        - "tmp/deploy/images/%{MACHINE}/boot-tftp.uImage"
        - "tmp/deploy/images/%{MACHINE}/boot-emmc.uImage"

  boot_artifacts:
    build-dir: "artifacts"
    builder:
      type: archive
      name: "s4-%{MACHINE}-boot-artifacts.tar.bz"
      items:
        - "%{YOCTOS_WORK_DIR}/%{DOM0_BUILD_DIR}/tmp/deploy/images/generic-armv8-xt/Image"
        - "%{YOCTOS_WORK_DIR}/%{DOM0_BUILD_DIR}/tmp/deploy/images/generic-armv8-xt/uInitramfs"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/bl31-%{MACHINE}.srec"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/tee-%{MACHINE}.srec"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/u-boot-elf-%{MACHINE}.srec"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xen-%{MACHINE}.uImage"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xenpolicy-%{MACHINE}"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/r8a779f0-%{MACHINE}-xen.dtb"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/boot-emmc.uImage"
        - "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/boot-tftp.uImage"

images:
  full:
    type: gpt
    desc: "Full SD-card/eMMC image"
    partitions:
      boot:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        items:
          "zephyr.bin": "%{ZEPHYR_WORK_DIR}/%{DOM0_BUILD_DIR}/build/zephyr/zephyr.bin"
          "linux-domd": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"
          "initramfs-domd": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/aos-image-initramfs-%{MACHINE}.cpio.gz"
          "xen": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xen-%{MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/xenpolicy-%{MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/%{XT_XEN_DTB_NAME}"

      domd_rootfs:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: raw_image
        image_path: "%{YOCTOS_WORK_DIR}/%{DOMD_BUILD_DIR}/tmp/deploy/images/%{MACHINE}/rcar-image-minimal-%{MACHINE}.ext4"
