desc: "Aos virtual development machine"
min_ver: "0.19"

variables:
  # Common build configuration

  YOCTOS_WORK_DIR: "yocto"
  GENERIC_MACHINE: "generic-armv8-xt"

  # Aos unit configuration

  UNIT_MODEL: "rcar-gen4-zephyr"
  UNIT_VERSION: "1.0"

  GEN4_DOM0_OS: "zephyr"

  # Aos FOTA configuration

  BUNDLE_IMAGE_VERSION: "0.4.0"
  BUNDLE_REF_VERSION: "0.3.0"
  BUNDLE_DOM0_TYPE: "full"
  BUNDLE_DOMD_TYPE: "full"
  BUNDLE_RH850_TYPE: ""
  RH850_IMAGE_VERSION: "1.0.0"
  RH850_IMAGE_PATH: "${TOPDIR}/../../../../sample_image_RH850/v1.0/OTA_AlcoholApp_Image"

  # Aos node configuration

  GEN4_DOMD_NODE_ID: "gen4-domd"
  GEN4_DOM0_NODE_ID: "gen4-dom0"
  GEN4_DOM0_NODE_TYPE: "zephyr-%{GEN4_DOM0_NODE_ID}"
  GEN4_DOMD_NODE_TYPE: "zephyr-%{GEN4_DOMD_NODE_ID}"

  UM_NODES: "%{GEN4_DOMD_NODE_ID}"
  SM_NODES: "%{GEN4_DOM0_NODE_ID}"
  IAM_NODES: "%{GEN4_DOM0_NODE_ID}"
  IAM_HOSTNAMES: "%{GEN4_DOM0_HOST_NAME}.%{GEN4_DOMAIN_NAME}"

  # Network configuration

  GEN4_DOMAIN_NAME: "gen4"
  GEN4_DOM0_HOST_NAME: "dom0"
  GEN4_DOMD_HOST_NAME: "domd"
  GEN4_DHCP_NET: "10.0.1"
  GEN4_DOM0_IP: "10.0.1.2"
  GEN4_DOMD_IP: "10.0.1.1"

  # Gen4 build configuration

  GEN4_MACHINE: "spider"
  GEN4_SOC_FAMILY: "r8a779f0"
  GEN4_ZEPHYR_DOM0_MACHINE: "rcar_spider"

  GEN4_DOM0_BUILD_DIR: "build/gen4/dom0"
  GEN4_DOMD_BUILD_DIR: "build/gen4/domd"
  GEN4_ZEPHYR_DOM0_DIR: "zephyr/gen4-dom0"

  GEN4_XT_DOMD_DTB_NAME: "%{GEN4_SOC_FAMILY}-%{GEN4_MACHINE}-domd.dtb"
  GEN4_XT_XEN_DTB_NAME: "%{GEN4_SOC_FAMILY}-%{GEN4_MACHINE}-xen.dtb"
  GEN4_XT_DOMD_CONFIG_NAME: "domd-spider.cfg"

  GEN4_XT_OPTEE_FLAVOR: "spider_s4"

  GEN4_XT_KERNEL_BRANCH: "v5.10.41/rcar-5.1.7.rc6-xt"
  GEN4_XT_KERNEL_REV: f5bb327b43cc6248cde9f3baf18e64257be8bc02

  GEN4_XT_DOMD_IMAGE: "rcar-image-minimal"

common_data:
  # Sources used by all domains
  common_sources: &COMMON_SOURCES
    - type: git
      url: "https://git.yoctoproject.org/poky"
      rev: "3155eb565f"
    - type: git
      url: "https://git.openembedded.org/meta-openembedded"
      rev: "7203130ed"
    - type: git
      url: "https://git.yoctoproject.org/meta-virtualization"
      rev: "beea119"
    - type: git
      url: "git://git.yoctoproject.org/meta-security"
      rev: "c62970f"
    - type: git
      url: "https://github.com/aoscloud/meta-aos"
      rev: "v7.2.0"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-common.git"
      rev: "c1ad85f"
    - type: git
      url: "https://github.com/aoscloud/meta-aos-rcar-gen4"
      rev: "develop"

  # Zephyr sources
  zephyr_sources: &ZEPHYR_SOURCES
    - type: west
      url: "https://github.com/aoscloud/aos_core_zephyr.git"
      rev: "v0.2.0"

  # Sources to be used in DomD
  domd_sources: &DOMD_SOURCES
    - type: git
      url: "git://git.yoctoproject.org/meta-selinux"
      rev: "1a13839"

  # Common configuration options for all yocto-based domains
  common_conf: &COMMON_CONF
    - [SSTATE_DIR, "${TOPDIR}/../../../../../common_data/sstate"]
    - [DL_DIR, "${TOPDIR}/../../../../../common_data/downloads"]

    # Skip warning about missing "virtualization" distro feature
    - [SKIP_META_VIRT_SANITY_CHECK, "1"]

    # Use hypervisor console on all guests
    - [SERIAL_CONSOLES, "115200;hvc0"]

    # Init manager
    - [INIT_MANAGER, "systemd"]

    # Do not install kernel image to rootfs to decrease initrd size
    - ["RDEPENDS_${KERNEL_PACKAGE_NAME}-base", ""]

    # Remove features that we are not using
    - [
        DISTRO_FEATURES_remove,
        "x11 gtk gobject-introspection-data wifi nfc
        bluetooth irda zeroconf 3g sysvinit acl alsa argp pcmcia usbgadget
        usbhost opengl ptest multiarch wayland vulkan sysvinit",
      ]

    # Aos configuration
    - [AOS_UNIT_MODEL, "%{UNIT_MODEL}"]
    - [AOS_UNIT_VERSION, "%{UNIT_VERSION}"]
    - [AOS_MAIN_NODE_ID, "%{GEN4_DOMD_NODE_ID}"]
    - [AOS_MAIN_NODE_HOSTNAME, "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME}"]
    - [AOS_DOM0_IMAGE_VERSION, "%{BUNDLE_IMAGE_VERSION}"]
    - [AOS_DOMD_IMAGE_VERSION, "%{BUNDLE_IMAGE_VERSION}"]

  # Common configuration options for all dom0
  dom0_conf:
    &DOM0_CONF # Disable HWDB which quite huge (around 15MB) and is not required at all
    - [BAD_RECOMMENDATIONS_append, " udev-hwdb"]

    # Aos configuration
    - [AOS_RUNNER, "runx"]

    - [AOS_BUNDLE_DIR, "${TOPDIR}/../../../.."]
    - [AOS_BUNDLE_OSTREE_REPO, "${TOPDIR}/../../../../rootfs_repo"]
    - [AOS_BUNDLE_IMAGE_VERSION, "%{BUNDLE_IMAGE_VERSION}"]
    - [AOS_BUNDLE_DOM0_TYPE, "%{BUNDLE_DOM0_TYPE}"]
    - [AOS_BUNDLE_DOMD_TYPE, "%{BUNDLE_DOMD_TYPE}"]
    - [AOS_DOMD_REF_VERSION, "%{BUNDLE_REF_VERSION}"]

  # Common configuration options for all domx
  domx_conf: &DOMX_CONF # add the static lib to SDK toolchain
    - [SDKIMAGE_FEATURES_append, " staticdev-pkgs"]

    # Remove ptest to reduce the build time
    - [DISTRO_FEATURES_remove, "ptest"]

    # Add Capacity Aware migration Strategy (CAS)
    - [MACHINE_FEATURES_append, " cas"]

    # Enable seccomp for crun
    - [DISTRO_FEATURES_append, " seccomp"]

    # Initramfs configuration
    - [INITRAMFS_IMAGE, "aos-image-initramfs"]
    - [INITRAMFS_IMAGE_BUNDLE, "0"]
    - [INITRAMFS_FSTYPES, "cpio.gz"]

    # Generate ext4 image files
    - [IMAGE_FSTYPES_append, " ext4"]

components:
  gen4-dom0:
    default: true
    build-dir: "%{GEN4_ZEPHYR_DOM0_DIR}"
    sources:
      - *ZEPHYR_SOURCES

    builder:
      type: zephyr
      board: "%{GEN4_ZEPHYR_DOM0_MACHINE}"
      target: aos_core_zephyr
      work_dir: build
      vars:
        - "CONFIG_AOS_NODE_ID=\\\\\\\"%{GEN4_DOM0_NODE_ID}\\\\\\\""
        - "CONFIG_AOS_NODE_TYPE=\\\\\\\"%{GEN4_DOM0_NODE_TYPE}\\\\\\\""
      shields:
        - "xen_dom0"
      additional_deps:
        - "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/Image-%{GEN4_MACHINE}.bin"
      target_images:
        - "build/zephyr/zephyr.bin"

  gen4-domd:
    default: true
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - *DOMD_SOURCES
      - type: git
        url: https://github.com/renesas-rcar/meta-renesas.git
        rev: "7c29e7bdae360a86fa77ef561e01cc0c18d2e01f"
        dir: "meta-renesas-gen4"

    builder:
      type: yocto
      work_dir: "%{GEN4_DOMD_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - *DOMX_CONF
        - [MACHINE, "%{GEN4_MACHINE}"]
        - [SOC_FAMILY, "%{GEN4_SOC_FAMILY}"]
        - [XT_DOM_NAME, "domd"]
        - [XT_DEVICE_TREES, "%{GEN4_XT_DOMD_DTB_NAME} %{GEN4_XT_XEN_DTB_NAME}"]
        - [XT_KERNEL_BRANCH, "%{GEN4_XT_KERNEL_BRANCH}"]
        - [XT_KERNEL_REV, "%{GEN4_XT_KERNEL_REV}"]
        - [XT_OP_TEE_FLAVOUR, "%{GEN4_XT_OPTEE_FLAVOR}"]
        - [GEN4_DOM0_OS, "%{GEN4_DOM0_OS}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN4_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN4_DOMD_HOST_NAME}"]
        - [DOM0_HOST_NAME, "%{GEN4_DOM0_HOST_NAME}"]
        - [DHCP_NET, "%{GEN4_DHCP_NET}"]
        - [DOM0_IP, "%{GEN4_DOM0_IP}"]
        - [DOMD_IP, "%{GEN4_DOMD_IP}"]
        - [DNSMASQ_INTERFACES, "tsn1"]
        - [DNSMASQ_ADDRESSES, "/wwwivi/%{GEN4_DOMD_IP}"]

        # Aos configuration
        - [AOS_NODE_ID, "%{GEN4_DOMD_NODE_ID}"]
        - [AOS_NODE_HOSTNAME, "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME}"]
        - [AOS_NODE_TYPE, "%{GEN4_DOMD_NODE_TYPE}"]
        - [AOS_IAM_NODES, "%{IAM_NODES}"]
        - [AOS_IAM_HOSTNAMES, "%{IAM_HOSTNAMES}"]
        - [AOS_SM_NODES, "%{SM_NODES}"]
        - [AOS_UM_NODES, "%{UM_NODES}"]
        - [AOS_UM_COMPONENT_PREFIX, "%{UNIT_MODEL}-%{UNIT_VERSION}-gen4-"]
        - [AOS_VIS_DATA_PROVIDER, "%{VIS_DATA_PROVIDER}"]

      build_target: "%{GEN4_XT_DOMD_IMAGE}"
      layers:
        - "../../../poky/meta"
        - "../../../poky/meta-poky"
        - "../../../poky/meta-yocto-bsp"
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-openembedded/meta-perl"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-selinux"
        - "../../../meta-security"
        - "../../../meta-aos"
        - "../../../meta-renesas-gen4/meta-rcar-gateway"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-driver-domain"
        - "../../../meta-aos-rcar-gen4/meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../meta-aos-rcar-gen4/meta-aos-rcar-common/meta-aos-rcar-common-domd"
        - "../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4/meta-aos-rcar-gen4-domx"
        - "../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4/meta-aos-rcar-gen4-domd"
        - "../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4/meta-aos-rcar-gen4-driver-domain"

      target_images:
        - "tmp/deploy/images/%{GEN4_MACHINE}/xen-%{GEN4_MACHINE}.uImage"
        - "tmp/deploy/images/%{GEN4_MACHINE}/xenpolicy-%{GEN4_MACHINE}"
        - "tmp/deploy/images/%{GEN4_MACHINE}/%{GEN4_XT_XEN_DTB_NAME}"
        - "tmp/deploy/images/%{GEN4_MACHINE}/rcar-image-minimal-%{GEN4_MACHINE}.ext4"
        - "tmp/work-shared/rcar-image-minimal-%{GEN4_MACHINE}/rootfs/var"
        - "tmp/deploy/images/%{GEN4_MACHINE}/Image-%{GEN4_MACHINE}.bin"
        - "tmp/deploy/images/%{GEN4_MACHINE}/dom0/aos/version"
        - "tmp/deploy/images/%{GEN4_MACHINE}/aos-image-initramfs-%{GEN4_MACHINE}.cpio.gz"

images:
  gen4_full:
    type: gpt
    desc: "Full UFS image"
    sector_size: 4096
    partitions:
      boot_a:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        items:
          "aos/version": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/dom0/aos/version"
          "xen": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xen-%{GEN4_MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xenpolicy-%{GEN4_MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/%{GEN4_XT_XEN_DTB_NAME}"
          "zephyr.bin": "%{GEN4_ZEPHYR_DOM0_DIR}/build/zephyr/zephyr.bin"
          "linux-domd": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/Image-%{GEN4_MACHINE}.bin"
          "initramfs-domd": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/aos-image-initramfs-%{GEN4_MACHINE}.cpio.gz"

      boot_b:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        items:
          "aos/version": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/dom0/aos/version"
          "xen": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xen-%{GEN4_MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xenpolicy-%{GEN4_MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/%{GEN4_XT_XEN_DTB_NAME}"
          "zephyr.bin": "%{GEN4_ZEPHYR_DOM0_DIR}/build/zephyr/zephyr.bin"
          "linux-domd": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/Image-%{GEN4_MACHINE}.bin"
          "initramfs-domd": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/aos-image-initramfs-%{GEN4_MACHINE}.cpio.gz"

      boot_env:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: vfat
        size: 16 MiB

      domd_rootfs:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: raw_image
        size: 1024 MiB
        image_path: "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/rcar-image-minimal-spider.ext4"

      domd_var:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: ext4
        size: 512 MiB
        items:
          "/": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/work-shared/rcar-image-minimal-%{GEN4_MACHINE}/rootfs/var"

      domd_aos:
        gpt_type: CA7D7CCB-63ED-4C53-861C-1742536059CC # LUKS partition
        type: empty
        size: 1024 MiB

parameters:
  # Aos VIS data provider
  VIS_DATA_PROVIDER:
    desc: "Specifies plugin for VIS automotive data"
    renesassimulator:
      default: true
      overrides:
        variables:
          VIS_DATA_PROVIDER: "renesassimulatoradapter"

    telemetryemulator:
      overrides:
        variables:
          VIS_DATA_PROVIDER: "telemetryemulatoradapter"
